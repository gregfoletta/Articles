---
title: Something Fishy in QLD
author: Greg Foletta
date: '2020-12-19'
slug: something-fishy-in-qld 
categories: [R]
---

<link href="index_files/anchor-sections/anchor-sections.css" rel="stylesheet" />
<script src="index_files/anchor-sections/anchor-sections.js"></script>


<p>This is a draft article looking at horse racing results, trying to determine with what kind of accuracy we can pick the winner of a race. We’ll be focusing on the Moonee Valley track in Melbourne (with a small digression at the end), trying a few different approaches:</p>
<ul>
<li>Picking a random horse</li>
<li>Picking the favourite</li>
<li>Looking at barrier position and track condition</li>
</ul>
<p>```{r include=FALSE}
getwd()
source(‘<sub>/Documents/Projects/Horse_Racing_Analysis/data/scripts.R’)
load(’</sub>/Documents/Projects/Horse_Racing_Analysis/data/full_results.Rdata’)</p>
<p>full_results &lt;- full_results %&gt;% util_full_result_types()</p>
<pre><code>
# Adding some additional variables
```{r}
full_results &lt;-
    full_results %&gt;% 
    mutate(odds.sp.win = ifelse(position != 1 | is.na(odds.sp), -1, odds.sp))</code></pre>
<p><code>{r message=FALSE} library(tidyverse) library(modelr) library(tidymodels) library(yardstick) library(vctrs)</code></p>
<div id="our-dataset" class="section level1">
<h1>Our Dataset</h1>
<p>We have a dataset that contains race results for all race tracks in Australia over the last ten years.</p>
<p>Here’s an example with some of the key variables selected:</p>
<pre class="{r}"><code>full_results %&gt;% 
    slice(1:10) %&gt;% 
    select(
        track, date, race_number, 
        position, horse.name, barrier, 
        margin, rail_position, race_duration, 
        length, condition
    )</code></pre>
<p>The more pertinent variables are:</p>
<ul>
<li>track: the name of the track.</li>
<li>date: the date of the race meet.</li>
<li>race_number: the number of the race within the meet.</li>
<li>position: the finishing position of the horse..</li>
<li>horse.name: the name of the horse.</li>
<li>barrier: the number of the barrier the horse started from.</li>
<li>margin: the margin of the horse away from the winniner</li>
<li>rail_position: the position of the rail on the track</li>
<li>race_duration: how long the race took.</li>
<li>length: the length of the race.</li>
<li>condition: the condition of the track.</li>
</ul>
</div>
<div id="the-key-questions" class="section level1">
<h1>The Key Questions</h1>
<p>In the first instance we’re going to be focusing on races at the Moonee Valley track over the past 5 years. We’re going to be trying different methods and models and observing how accurate these are in picking the winner of each race.</p>
</div>
<div id="monee-valley" class="section level1">
<h1>Monee Valley</h1>
<p>We extract out race results from Moonee Valley over the last five years.</p>
<pre class="{r}"><code>mv_results &lt;-
    full_results %&gt;%
    filter(track == &#39;Moonee Valley&#39; &amp; year(date) &gt; 2015)</code></pre>
<p>This dataset has <code>r mv_results %&gt;% distinct(race_id) %&gt;% nrow()</code> races in it.</p>
<div id="approach-1-picking-a-random-horse" class="section level2">
<h2>Approach 1: Picking a Random Horse</h2>
<p>In this approach, we look at the last five years of races at Moonee Valley. We pick a random horse from each race and “place” a dollar bet. If it wins, we get the starting price odds back, and if it loses we of course lose our dollar.</p>
<pre class="{r}"><code># Function that picks a random horse from each race (based on race_id)
mdl_hr_random &lt;- function(data) {
    data %&gt;%
    group_by(race_id) %&gt;% 
    mutate( 
        .pred = as_factor( sample(1:n()) ),
        .pred.result = factor(
            ifelse(.pred == 1, &#39;Win&#39;, &#39;Loss&#39;),
            levels = c(&#39;Win&#39;, &#39;Loss&#39;)
        )
    ) %&gt;% 
    ungroup()
}

# Extract out our &#39;winning&#39; predictions
mv_random &lt;-
    mv_results %&gt;%
    mdl_hr_random() %&gt;% 
    filter(.pred.result == &#39;Win&#39;)
    
# How accurate is the model:
mv_random %&gt;% accuracy(result, .pred.result)</code></pre>
<p>So when we pick a random horse, we are <code>r mv_random %&gt;% accuracy(result, .pred.result) %&gt;% pull(.estimate) %&gt;% round(3) *100</code>% accurate. This makes sense, as on average there are <code>r mv_results %&gt;% group_by(race_id) %&gt;% slice_max(barrier) %&gt;% ungroup() %&gt;% summarise(m = mean(barrier)) %&gt;% pull(m) %&gt;% round(3)</code> horses in each race.</p>
<p>Let’s place a dollar bet on a random horse in each race over the past five years.</p>
<pre class="{r}"><code>mv_random %&gt;%
    mutate(
        cumulative_return = cumsum(odds.sp.win),
        index = 1:n()
    ) %&gt;% 
    ggplot() +
    geom_line(aes(index, cumulative_return, colour = as_factor(year(date)))) +
    geom_hline(yintercept = 0) +
    labs(
        x = &#39;Race Index&#39;,
        y = &#39;Cumulative Return (Dollars)&#39;,
        title = &#39;Moonee Valley - Last Five Years&#39;,
        subtitle = &#39;Cumulative Return - Pick: Random Horse&#39;,
        colour = &#39;Year&#39;
    )</code></pre>
</div>
</div>
<div id="approach-1-betting-on-the-favourite" class="section level1">
<h1>Approach 1: Betting on the Favourite</h1>
<p>In this approach, we simply bet on the favourite in each race based on their starting price.</p>
<pre class="{r}"><code># Function that picks the horse with the lowest odds. 
mdl_hr_favourite &lt;- function(data) {
    data %&gt;% 
    group_by(race_id) %&gt;% 
    mutate(
        .pred = order(odds.sp),
        .pred.result = factor(
            ifelse(.pred == 1, &#39;Win&#39;, &#39;Loss&#39;),
            levels = c(&#39;Win&#39;, &#39;Loss&#39;)
        )
    ) %&gt;% 
    ungroup()
}

mv_favourite &lt;-
    mv_results %&gt;% 
    mdl_hr_favourite() %&gt;% 
    filter(.pred.result == &#39;Win&#39;)

mv_favourite %&gt;% accuracy(result, .pred.result)</code></pre>
<p>By picking the favourite, we’ve increased our accuracy to <code>r mv_favourite %&gt;% accuracy(result, .pred.result) %&gt;% pull(.estimate) %&gt;% round(3) * 100</code>%. This is the consensus view, and we can consider it a distillation of a whole bunch of factors: track conditions, weather, form, make-up of the race. This is our baseline that we would like to beat, and with this level of accuracy it’s going to be difficult. Of course if it wasn’t difficult, everyone would be making money!</p>
<p>Again, let’s place a dollar bet on each race and see what our returns are.</p>
<pre class="{r}"><code>mv_favourite %&gt;% 
    mutate(
        cumulative_return = cumsum(odds.sp.win),
        index = 1:n()
    ) %&gt;% 
    ggplot() +
    geom_line(aes(index, cumulative_return, colour = factor(year(date)))
    ) +
    geom_hline(yintercept = 0) +
    labs(
        title = &#39;Moonee Valley - Last Five Years&#39;,
        subtitle = &#39;Cumulative Return - Pick: Favourite&#39;,
        x = &#39;Race Index&#39;,
        y = &#39;Cumulative Winnings (Dollars)&#39;,
        colour = &#39;Year&#39;
    )</code></pre>
<p>Now this is if we bet on every single race over the past 5 years, which might not be realistic for some punters. Instead, let’s put a dollar bet on 100 random races over the five years, but do it 20 times so see the how varied the return is.</p>
<pre class="{r}"><code>mv_favourite %&gt;% 
    rep_sample_n(size = 100, reps = 20) %&gt;%
    group_by(replicate) %&gt;% 
    arrange(date) %&gt;% 
    mutate(
        cumulative_return = cumsum(odds.sp.win),
        index = 1:n()
    ) %&gt;% 
    ggplot() +
    geom_line(
        aes(
            index, cumulative_return,
            group = replicate, colour = as_factor(year(date))
        )
    ) +
    geom_hline(yintercept = 0) +
    labs(
        title = &#39;Moonee Valley - Last Five Years - 100 Random Races&#39;,
        subtitle = &#39;Cumulative Return - Pick: Favourite&#39;,
        x = &#39;Race Index&#39;,
        y = &#39;Cumulative Winnings (Dollars)&#39;,
        colour = &#39;Year&#39;
    )
    </code></pre>
<div id="approach-3-barrier-position" class="section level2">
<h2>Approach 3: Barrier Position</h2>
<p>In this approach, we’re going to look at how the barrier, rail position, and group conditions affect the result.</p>
<pre class="{r}"><code># Filter out races lengths and entire circuit rail positions.
# Extract out the rail position in metres and add a win/loss
# categorical variable
mv_results_1100 &lt;-
    full_results %&gt;% 
    filter(track == &#39;Moonee Valley&#39; &amp; !is.na(barrier)) %&gt;% 
    filter(str_detect(rail_position, &#39;Entire Circuit&#39;)) %&gt;% 
    mutate(
        condition = fct_reorder(condition, condition.num),
        rail_metres = str_match(rail_position, &#39;\\d&#39;),
        rail_metres = ifelse(is.na(rail_metres), 0, rail_metres),
        win = ifelse(position == 1, TRUE, FALSE)
    )</code></pre>
<pre class="{r}"><code>mv_results_1100 %&gt;% 
    group_by(race_id) %&gt;%
    slice_head() %&gt;% 
    ungroup() %&gt;% 
    count(condition, condition.num) %&gt;% 
    mutate(condition = fct_reorder(condition, condition.num)) %&gt;% 
    ggplot() +
    geom_col(aes(condition, n)) +
    geom_label(aes(condition, n, label = n)) +
    labs(
        title = &#39;Moonee Valley - Races &lt;= 1100m&#39;,
        subtitle = &#39;Number of Races per Track Condition&#39;,
        x = &#39;Track Condition&#39;,
        y = &#39;# of Races&#39;
    )
    </code></pre>
<pre class="{r}"><code>mv_results_1100 %&gt;% 
    group_by(race_id) %&gt;%
    slice_head() %&gt;% 
    ungroup() %&gt;% 
    count(rail_metres) %&gt;% 
    ggplot() +
    geom_col(aes(rail_metres, n)) +
    geom_label(aes(rail_metres, n, label = n)) +
    labs(
        title = &#39;Moonee Valley - Races &lt;= 1100m&#39;,
        subtitle = &#39;Number of Races per Full Track Rail Position&#39;,
        x = &#39;Rail Position (Metres)&#39;,
        y = &#39;# of Races&#39;
    )
    </code></pre>
<p>This gives us a total of <code>r mv_results_1100 %&gt;% distinct(race_id) %&gt;% nrow()</code> races. We first take a look at the win to run ratios for each barrier. If the barrier position has no impact, then we would expect to see these ratios around .1, just like our random pick previously.</p>
<pre class="{r}"><code>mv_results_1100 %&gt;% 
    group_by(barrier) %&gt;% 
    summarise(win_ratio = sum(win) / n(), .groups = &#39;drop&#39;) %&gt;% 
    ggplot() +
    geom_col(aes(as_factor(barrier), win_ratio)) +
    labs(
        title = &#39;Moonee Valley - Races &lt;= 1100m&#39;,
        subtitle = &#39;Barrier Win Ratios&#39;,
        x = &#39;Barrier&#39;,
        y = &#39;Win/Run Ratio&#39;
    )</code></pre>
<pre class="{r}"><code>mv_results_1100 %&gt;%
    filter(result == &#39;Win&#39;) %&gt;% 
    ggplot() +
    geom_jitter(aes(barrier, rail_metres, colour = result), alpha = .5) +
    facet_wrap(~condition)</code></pre>
<p>What about if we also take into account the condition of the track? First we take a look at how many races have been raced per groun condition.</p>
<pre class="{r}"><code>mv_results_1100 %&gt;% 
    group_by(race_id) %&gt;%
    slice_head() %&gt;% 
    ungroup() %&gt;% 
    count(condition, condition.num) %&gt;% 
    mutate(condition = fct_reorder(condition, condition.num)) %&gt;% 
    ggplot() +
    geom_col(aes(condition, n)) +
    geom_label(aes(condition, n, label = n)) +
    labs(
        title = &#39;Moonee Valley - Races &lt;= 1100m&#39;,
        subtitle = &#39;Number of Races per Track Condition&#39;,
        x = &#39;Track Condition&#39;,
        y = &#39;# of Races&#39;
    )
    </code></pre>
</div>
</div>
<div id="all-tracks" class="section level1">
<h1>All Tracks</h1>
<div id="approach-betting-on-the-favourite" class="section level2">
<h2>Approach: Betting on the Favourite</h2>
<p>Let’s take a look at all tracks where there have been at least than 100 races over the past five years and see how betting on the favourite would have worked out.</p>
<p>Note that there can be times when there is more than one horse as the favourite. In these instances, we place a bet on each horse.</p>
<pre class="{r}"><code>full_dollar_bets &lt;-
    full_results %&gt;%
    add_count(track) %&gt;% 
    filter(n &gt; 100) %&gt;% 
    filter(year(date) &gt; 2015) %&gt;% 
    group_by(race_id) %&gt;% 
    slice_min(odds.sp, with_ties = TRUE) %&gt;%
    ungroup() %&gt;% 
    group_by(track, state) %&gt;% 
    summarise(dollar_bet = sum(odds.sp.win)) %&gt;% 
    ungroup()

full_dollar_bets %&gt;% 
    ggplot() + 
    geom_col(aes(reorder(track, dollar_bet), dollar_bet, fill = state)) +
    theme(
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) +
    labs(
        title = &#39;Betting on Favourite - Cumulative Winnings - Last 5 Years&#39;,
        subtitle = &#39;Tracks with more than 120 races&#39;,
        x = &#39;&#39;,
        y = &#39;Cumulative Winnings ($)&#39;,
        fill = &#39;State&#39;
    )</code></pre>
<p>What are the top and bottom 20 tracks?</p>
<pre class="{r}"><code># Top 30
full_dollar_bets %&gt;%
    slice_max(dollar_bet, n = 30) %&gt;% 
    ggplot() + 
    geom_col(aes(reorder(track, dollar_bet), dollar_bet, fill = state)) +
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1)
    ) +
    labs(
        title = &#39;Betting on Favourite - Cumulative Winnings - Last 5 Years&#39;,
        subtitle = &#39;Tracks with more than 120 races&#39;,
        x = &#39;Track Name&#39;,
        y = &#39;Cumulative Winnings ($)&#39;,
        fill = &#39;State&#39;
    )
# Bottom 30
full_dollar_bets %&gt;% 
    slice_min(dollar_bet, n = 30) %&gt;% 
    ggplot() + 
    geom_col(aes(reorder(track, dollar_bet), dollar_bet, fill = state)) +
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1)
    ) +
    labs(
        title = &#39;Betting on Favourite - Cumulative Winnings - Last 5 Years&#39;,
        subtitle = &#39;Tracks with more than 120 races&#39;,
        x = &#39;Track Name&#39;,
        y = &#39;Cumulative Winnings ($)&#39;,
        fill = &#39;State&#39;
    )</code></pre>
</div>
</div>
