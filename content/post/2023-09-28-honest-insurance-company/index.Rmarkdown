---
title: Honest Insurance Company
author: Greg Foletta
date: '2023-09-28'
slug: []
categories: []
tags: []
images: []
---

```{r include=FALSE}
library(tidyverse)
library(tidybayes)
library(RSelenium)
library(rvest)
library(glue)
library(cmdstanr)
library(here)
library(tidybayes)
library(bayesplot)
library(gganimate)
library(scales)
```



# Data Aquisition

```{sh eval=FALSE, include=FALSE}
# Stop running containers
if [ $(docker container ls -q --filter name=rsel --all) ]
then
        docker container stop rsel
        docker container rm rsel
fi
```

```{sh eval=FALSE, echo=TRUE, results = 'hide'}
docker run -d -p 4444:4444 --name rsel selenium/standalone-firefox:latest
```

```{r eval = FALSE, echo=TRUE, results = 'hide'}
rs <- remoteDriver(remoteServerAddr = '172.17.0.2', port = 4444L)
rs$extraCapabilities$pageLoadStrategy <- "eager"
rs$open()
```

```{r eval = FALSE}
kluger_source <-
    tibble(
        offset = 12 * c(0:100)
    ) |> 
    mutate(
        source = map(offset, ~{ 
                print(glue("Reqesting {.x}"))
                rs$navigate(glue("https://www.carsales.com.au/cars/used/toyota/kluger/?offset={.x}"))
                rs$getPageSource() |> pluck(1) |> read_html()
        } )
    )
```


```{r}
xpath_text <- function(html, xpath) { html_elements(html, xpath = xpath) |> html_text() }
```

```{r eval = FALSE}
kluger_data <-
    kluger_source |> 
    mutate(
        # Get entires that have odometer
        cards = map(source, ~html_elements(.x, xpath = "//li[@data-type = 'Odometer']/ancestor::div[@class = 'card-body']")),
        # Extract specific properties 
        price = map(cards, ~xpath_text(.x, xpath = ".//a[@data-webm-clickvalue = 'sv-price']")),
        title = map(cards, ~xpath_text(.x, xpath = ".//a[@data-webm-clickvalue = 'sv-title']")),
        odometer = map(cards, ~xpath_text(.x, xpath = ".//li[@data-type = 'Odometer']")),
        body = map(cards, ~xpath_text(.x, xpath = ".//li[@data-type = 'Body Style']")),
        transmission = map(cards, ~xpath_text(.x, xpath = ".//li[@data-type = 'Transmission']")),
        engine = map(cards, ~xpath_text(.x, xpath = ".//li[@data-type = 'Engine']"))
    ) |>
    select(-c(source, cards)) |>
    unnest(everything())
```

```{r include=FALSE}
kluger_data <- read_csv('data/carsales_kluger.csv')
```


```{r, comment=''}
kluger_data <-
kluger_data |>
    mutate(
        odometer = parse_number(odometer),
        odometer_Mm = odometer / 1000,
        price = parse_number(price),
        year = as.integer( str_extract(title, "^(\\d{4})", group = TRUE) ),
        drivetrain = str_extract(title, "\\w+$"),
        model = str_extract(title, "Toyota Kluger ([-\\w]+)", group = TRUE)
    )

str(kluger_data)
```

```{r echo = FALSE}
kluger_data |>
    ggplot() +
    geom_point(aes(odometer_Mm, price)) +
    labs(
        title = "Market for Toyota Klugers",
        subtitle = "Odometer Versus Price",
        x = "Odometer (megametres)",
        y = "Price ($)"
    ) + 
    scale_x_continuous(labels = scales::comma) +
    scale_y_continuous(labels = scales::comma) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r echo = FALSE}
kluger_data |>
    ggplot() +
    geom_point(aes(odometer_Mm, log(price))) +
    labs(
        title = "Toyota Kluger Market",
        subtitle = "Odometer Versus Log(Price)",
        x = "Odometer (megametres)",
        y = "Log(Price) ($)"
    ) +
    scale_x_continuous(labels = scales::comma) +
    scale_y_continuous(labels = scales::comma) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r echo=FALSE}
kluger_data |>
    ggplot() +
    geom_point(aes(odometer_Mm, log(price), colour = model), alpha = .3) +
    facet_wrap(~model) +
    labs(
        title = "Toyota Kluger Market",
        subtitle = "Odometer versus Log(Price) by Model",
        x = "Odometer (megametres)",
        y = "Log(Price) ($)"
    ) +
    scale_x_continuous(labels = scales::comma) +
    scale_y_continuous(labels = scales::comma) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

# Modelling
```{r include=FALSE}
model_file_path <- here('content', 'post', '2023-09-28-honest-insurance-company', 'linear.stan')
```

```{r comment=''}
kluger_model <- cmdstan_model(model_file_path)
kluger_model$print()
```
```{r echo=TRUE, comment=''}
kluger_fit <- kluger_model$sample(
    data = compose_data(kluger_data),
    seed = 123,
    chains = 4,
    parallel_chains = 4,
    refresh = 500,
)
```
    
```{r echo = FALSE}
kluger_fit |> 
    gather_draws(a, b) |>
    recover_types() |> 
    ggplot() +
    geom_histogram(aes(.value, fill = as.factor(.chain)), bins = 100) +
    facet_wrap(vars(.variable), scales = 'free') +
    labs(
        title = "Toyota Kluger Market Linear Model",
        subtitle = "Histogram of Posterior Draws of Alpha & Beta Coefficients",
        x = "Coefficient Value",
        y = "Frequency",
        fill = "Chain"
    )
```
```{r echo=FALSE}
kluger_fit |> 
    gather_draws(a,b, sigma) |>
    ggplot() +
    geom_line(aes(.iteration, .value, colour = as_factor(.chain)), alpha = .8) +
    facet_grid(vars(.variable), scales = 'free_y') + 
    labs(
        title = "Toyota Kluger Market Model",
        subtitle = "MCMC Trace Plot",
        x = "Iteration",
        y = "Value",
        colour = "Chain"
    )
```


```{r echo = FALSE}
#fit_mean_a <- kluger_fit$summary()$mean[2]
#fit_mean_b <- kluger_fit$summary()$mean[3]

kluger_fit_animation <-
    kluger_fit |>
    spread_draws(a, b) |>
    recover_types() |> 
    ggplot() +
    geom_point(data = kluger_data, aes(odometer_Mm, log(price))) +
    geom_abline(aes(intercept = a, slope = b, group = .draw), colour = 'lightblue') +
    transition_reveal(.draw) +
    guides(colour = guide_legend(override.aes = list(alpha = 1))) +
    labs(
        title = "Toyota Kluger Market Model",
        subtitle = "Odometer vs Log(Price) with MCMC Coefficients (Draw {frame_along})",
        x = "Odometer (Megametres)",
        y = "Log(Price) ($)"
    )
 
animate(kluger_fit_animation, renderer = gifski_renderer())
```
```{r echo=FALSE}
kluger_fit |>
    recover_types() |>
    spread_draws(y_s[i]) |>
    sample_frac(size = .1) |>
    select(-c(.chain, .iteration, .draw)) |>
    nest(y_s = y_s) |>
    bind_cols(kluger_data) |>
    unnest(y_s) |>
    ggplot() +
    geom_point(aes(odometer_Mm, y_s), colour = 'lightblue', alpha = .05) +
    geom_point(data = kluger_data, aes(odometer_Mm, log(price)), alpha = .5) +
    labs(
        title = "Toyota Kluger Market Model",
        subtitle = "Odometer vs Log(Price) with Postierior Predictions", 
        x = "Odometer (Megametres)",
        y = "Log(Price) ($)"
    )
```


```{r}
kluger_fit |>
    spread_draws(a,b) |>
    ggplot() +
    geom_point(data = kluger_data, aes(odometer_Mm, price)) +
    geom_function(fun = ~exp(11.14 - 0.00626 * .x), linewidth = 2, colour = 'lightblue') +
    labs(
        title = "Toyota Kluger Market Model",
        subtitle = "Odometer vs Price",
        x = "Odometer (Megametres)",
        y = "Log(Price) ($)"
    )
```


```{r, comment=''}
kluger_fit$summary()
```

```{sh eval=FALSE, include=FALSE}
docker container stop rsel
docker container rm rsel
```

